name: Deploy to Discord

on:
  push:
      branches:
            - main
              pull_request:
                  types:
                        - closed

                        jobs:
                          auto-merge:
                              runs-on: ubuntu-latest
                                  if: github.event_name == 'pull_request' && github.event.pull_request.merged == false
                                      steps:
                                            - name: Checkout code
                                                    uses: actions/checkout@v3

                                                          - name: Enable auto-merge
                                                                  run: |
                                                                            gh pr merge ${{ github.event.pull_request.number }} --auto --squash
                                                                                    env:
                                                                                              GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

                                                                                                deploy:
                                                                                                    runs-on: ubuntu-latest
                                                                                                        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
                                                                                                            steps:
                                                                                                                  - name: Checkout code
                                                                                                                          uses: actions/checkout@v3
                                                                                                                          
                                                                                                                                - name: Set up Python
                                                                                                                                        uses: actions/setup-python@v4
                                                                                                                                                with:
                                                                                                                                                          python-version: '3.9'
                                                                                                                                                          
                                                                                                                                                                - name: Install dependencies
                                                                                                                                                                        run: |
                                                                                                                                                                                  python -m pip install --upgrade pip
                                                                                                                                                                                            pip install -r requirements.txt
                                                                                                                                                                                            
                                                                                                                                                                                                  - name: Notify Discord - Deployment Started
                                                                                                                                                                                                          run: |
                                                                                                                                                                                                                    curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
                                                                                                                                                                                                                                -H 'Content-Type: application/json' \
                                                                                                                                                                                                                                            -d '{
                                                                                                                                                                                                                                                          "content": "üöÄ **Deployment Started**",
                                                                                                                                                                                                                                                                        "embeds": [{
                                                                                                                                                                                                                                                                                        "title": "Kiroku Bot Deployment",
                                                                                                                                                                                                                                                                                                        "description": "Deploying latest changes from main branch",
                                                                                                                                                                                                                                                                                                                        "color": 3447003,
                                                                                                                                                                                                                                                                                                                                        "fields": [
                                                                                                                                                                                                                                                                                                                                                          {
                                                                                                                                                                                                                                                                                                                                                                              "name": "Commit",
                                                                                                                                                                                                                                                                                                                                                                                                  "value": "${{ github.sha }}",
                                                                                                                                                                                                                                                                                                                                                                                                                      "inline": true
                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                          {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              "name": "Author",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  "value": "${{ github.actor }}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "inline": true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Deploy bot
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo "Deploying Kiroku bot..."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    python bot.py
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - name: Notify Discord - Deployment Success
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if: success()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                -H 'Content-Type: application/json' \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            -d '{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "content": "‚úÖ **Deployment Successful**",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "embeds": [{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "title": "Kiroku Bot",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "description": "Latest deployment completed successfully",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "color": 3066993,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "fields": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              "name": "Commit",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  "value": "${{ github.sha }}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "inline": true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              "name": "Time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  "value": "'"$(date)"'",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "inline": true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Notify Discord - Deployment Failed
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if: failure()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              -H 'Content-Type: application/json' \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          -d '{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "content": "‚ùå **Deployment Failed**",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "embeds": [{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "title": "Kiroku Bot",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "description": "Latest deployment failed. Check logs for details.",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "color": 15158332,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "fields": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "name": "Commit",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "value": "${{ github.sha }}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "inline": true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }'
